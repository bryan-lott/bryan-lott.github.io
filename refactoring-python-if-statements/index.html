<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta content="width=device-width, initial-scale=1" name="viewport" />
  <meta content="#ffffff" name="theme-color" />
  <meta content="#da532c" name="msapplication-TileColor" />

  
  
  
  
  

  
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/galleria@1.6.1/dist/themes/folio/galleria.folio.min.css" integrity="sha384-+rY0QD+LRnTOquDMzGa9lXU6jIwdiQuwCJQ2cdcW0qeP/0UbjQCZlXnRsUMA+9pH" crossorigin="anonymous">
  

  

  <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/jpswalsh/academicons@1.9.1/css/academicons.min.css" integrity="sha384-FIue+PI4SsI9XfHCz8dBLg33b0c1fMJgNU3X//L26FYbGnlSEfWmNT7zgWc2N9b6" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.4/css/all.min.css" integrity="sha384-DyZ88mC6Up2uqS4h/KRgHuoeGwBcD4Ng9SiP4dIRy0EXTlnuz47vAwmeGwVChigm" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.9.3/css/bulma.min.css" integrity="sha384-IJLmUY0f1ePPX6uSCJ9Bxik64/meJmjSYD7dHaJqTXXEBE4y+Oe9P2KBZa/z7p0Q" crossorigin="anonymous">
  <link href="https://bryan-lott.github.io/deep-thought.css" rel="stylesheet" />
  
  

  <title>
    
(import this) | Refactoring Python if Statements

  </title>

  
  
  

  
</head>

<body class="has-background-white">
  <nav aria-label="section navigation" class="navbar is-light" role="navigation">
    <div class="container">
      <div class="navbar-brand">
        <a class="navbar-item is-size-5 has-text-weight-bold" href="https:&#x2F;&#x2F;bryan-lott.github.io&#x2F;">(import this)</a>
        <a aria-expanded="false" aria-label="menu" class="navbar-burger burger" data-target="navMenu" role="button">
          <span aria-hidden="true"></span>
          <span aria-hidden="true"></span>
          <span aria-hidden="true"></span>
        </a>
      </div>
      <div class="navbar-menu" id="navMenu">
        <div class="navbar-end has-text-centered">
          
          
          
          <a class="navbar-item has-text-weight-semibold" href="https:&#x2F;&#x2F;bryan-lott.github.io&#x2F;">
            Home
          </a>
          
          <a class="navbar-item has-text-weight-semibold" href="https:&#x2F;&#x2F;bryan-lott.github.io&#x2F;&#x2F;now">
            Now
          </a>
          
          <a class="navbar-item has-text-weight-semibold" href="https:&#x2F;&#x2F;bryan-lott.github.io&#x2F;&#x2F;uses">
            Uses
          </a>
          
          <a class="navbar-item has-text-weight-semibold" href="https:&#x2F;&#x2F;bryan-lott.github.io&#x2F;&#x2F;about">
            About
          </a>
          
          
          
          <a class="navbar-item" id="nav-search" title="Search" data-target="#search-modal">
            <span class="icon">
              <i class="fas fa-search"></i>
            </span>
          </a>
          <a class="navbar-item" id="dark-mode" title="Switch to dark theme">
            <span class="icon">
              <i class="fas fa-adjust"></i>
            </span>
          </a>
        </div>
      </div>
    </div>
  </nav>

  
  

  
<section class="section">
  <div class="container">
    <div class="columns">
      <div class="column is-8 is-offset-2">
        <article class="box">
          <h1 class="title">
            Refactoring Python if Statements
          </h1>
          <p class="subtitle"></p>
          <div class="columns is-multiline is-gapless">
            <div class="column is-8">
              
<span class="icon-text has-text-grey">
  <span class="icon">
    <i class="fas fa-user"></i>
  </span>
  <span>Bryan Lott published on</span>
  <span class="icon">
    <i class="far fa-calendar-alt"></i>
  </span>
  <span><time datetime="2017-12-23">December 23, 2017</time></span>
</span>

            </div>
            <div class="column is-4 has-text-right-desktop">
              
<span class="icon-text has-text-grey">
  <span class="icon">
    <i class="far fa-clock"></i>
  </span>
  <span>10 min,</span>
  <span class="icon">
    <i class="fas fa-pencil-alt"></i>
  </span>
  <span>1946 words</span>
</span>

            </div>
            <div class="column">
              
            </div>
            <div class="column has-text-right-desktop">
              
            </div>
          </div>
          <div class="content mt-2">
            <p>Note: I'm not recommending the following refactoring to everyone, nor am I saying it was even a good idea.  It did, however, work out quite well for myself and my team.</p>
<pre data-lang="python" class="language-python "><code class="language-python" data-lang="python">if pred_1 == &#x27;first&#x27;:
    output_data = output_data._replace(output_data_1=pred_3, output_data_2=pred_4)
    if pred_2 and self.state_management_3 in pred_2:
        output_data = merge_namedtuple(output_data, self.process_data_1())
    elif pred_3 == state_management_2.state1:
        if pred_4:
            output_data = merge_namedtuple(output_data, self.process_data_2())
        else:
            output_data = merge_namedtuple(output_data, self.process_data_3())
            if orig_data_2 in [state_management_1.STATE1, state_management_1.STATE2]:
                output_data = output_data._replace(output_data_1=orig_data_1, output_data_2=orig_data_2)
    elif pred_3 in [state_management_2.state2, state_management_2.state3]:
        if pred_4:
            output_data = merge_namedtuple(output_data, self.process_data_2())
        else:
            output_data = merge_namedtuple(output_data, self.process_data_3())
            output_data = output_data._replace(output_data_1=state_management_2.state1, output_data_2=state_management_1.STATE1)
elif pred_1 == &#x27;second&#x27;:
    if pred_2 and self.state_management_3 in pred_2:
        output_data = merge_namedtuple(output_data, self.process_data_1())
    elif pred_3 == state_management_2.state2:
        if pred_4 in [state_management_1.STATE3, state_management_1.STATE4, state_management_1.STATE5]:
            if pred5:
                output_data = merge_namedtuple(output_data, self.process_data_4())
        elif pred_4 in [state_management_1.STATE7, state_management_1.STATE8, state_management_1.STATE6, state_management_1.STATE9]:
            output_data = merge_namedtuple(output_data, self.process_data_2())
            if pred_4 == output_data.state_2:
                output_data = output_data._replace(state_1=None, state_2=None)
    elif pred_3 == state_management_2.state1 and not pred_4 and pred5:
        output_data = merge_namedtuple(output_data, self.process_data_4())
        output_data = output_data._replace(state_1=output_data.sub_data.state_1, state_2=output_data.sub_data.state_2)
    elif pred_3 == state_management_2.state1 and pred_4 and pred6:
        output_data = merge_namedtuple(output_data, self.process_data_2())
</code></pre>
<p>Still with me?</p>
<p>...</p>
<p>Yeah, pretty sure I lost about 90% of you with that if-block.</p>
<p>This isn't the actual code that I ended up refactoring, but it's convoluted enough to give the same gut-wrenching feeling from it.  I've also done my best to anonymize it so to protect the guilty.</p>
<h2 id="the-white-whale">The White Whale</h2>
<p>Story time!</p>
<p>I ran into this block of code my 3rd or 4th day on the job and recoiled in horror at it.  At the same time, it fascinated me that this was the encoding of some admittedly convoluted but mission-critical business logic into Python.  The &quot;standard&quot; refactor for an if-elif-elif-elif block in Python is to reach for a dictionary (hashmap for those not familiar with Python), encode the predicates into the keys and the functions to be called in the values.</p>
<p>Great... but... does that mean we need a nested dictionary here and, more importantly, would that actually make the code more readable?</p>
<pre data-lang="python" class="language-python "><code class="language-python" data-lang="python"># we start with the first &quot;layer&quot;:
{&#x27;first&#x27;: {}
 &#x27;second&#x27;: {}}

# cool, that was easy... now the second &quot;layer&quot;:
{&#x27;first&#x27;: {pred_2: {}
           pred_3: {}
           }}

#uhhhh... we&#x27;re going off the rails here...
</code></pre>
<p>The problem here comes down to the different layers not being symmetrical.  They all have various conditions and an amalgamation of predicates, states, and even types (some are lists, others are enums, others are booleans).</p>
<p>So... un-refactorable?</p>
<p>I'll be honest, at this point I was wondering if it really was un-refactorable.</p>
<h2 id="the-one-that-got-away">The One That Got Away</h2>
<p>I left the code as-is for quite some time.  Months actually.  It was always sitting in the back of my head though, like an itch you can't quite scratch.  Refactoring this bit of code was always on my to-do list, but I could never seem to find the time to really think about it.  Add on to this, it was mission-critical business logic encoding.  That always carries an inherent risk when you're refactoring.  There were tests around the code, but they ended up having major holes.</p>
<h2 id="a-light-on-the-horizon">A Light on the Horizon</h2>
<p>Tests...</p>
<p>The golden rule of refactoring is that you never do it without a good set of tests to verify old and new logic.</p>
<p>Hah!  Of course!  Write unit tests around the entire if-statement-of-crazy.  If nothing else, I figured this would give me a deeper understanding of the business logic and the all-crucial &quot;why&quot; to some of the crazy logic.  While I was doing this, I sat down with a number of my coworkers to fill in the gaps in my knowledge.  As always, ask the people that were there first!</p>
<h2 id="darkness">Darkness</h2>
<p>While I was chatting and interviewing my coworkers about this bit of code, there was an ominous phrase that kept popping up...</p>
<blockquote>
<p>This isn't the first time someone's tried to refactor that if statement.</p>
</blockquote>
<p>...great...</p>
<p>After some introspection and some poking and prodding at my ego, I finally decided that it'd make a fun side project to <em>try</em>.  If I didn't succeed, no worries, at least I had added a ton of tests around it so the next time it needed to change, we could be safe about changing it!</p>
<h2 id="the-hunt">The Hunt</h2>
<p>After a number of false starts, thrown out code, and late nights I hit upon an interesting idea.</p>
<p>To look up a key in a Python dictionary, the <code>get</code> method does two things.  First, it hashes the key you're looking up and compares it with all the hashed keys in the dictionary.  The second thing it does an equality comparison of the unhashed lookup key and unhashed dictionary key.  I assume the second round is to prevent hash collisions, but I honestly don't know.</p>
<p>At the same time, I was looking into using <code>namedtuples</code> as a way to encode multiple values into the key.  They have the advantage of being immutable and have easy methods to get and set values (important for readability of the final code).</p>
<h2 id="shot-and-a-miss">Shot and a Miss</h2>
<p>That was my next thought, encode all the logic into a <code>namedtuple</code> &quot;template&quot; and compare the actual data against the keys in the dictionary.</p>
<p>Well, there's a problem with that.  At runtime, we don't always have all the data necessary for a given branch of the codebase and, in fact, some of the data may be set, but it may not matter.</p>
<p>The upshot of this is that some branches of the if statement have an importance priority of the data looked up that's different than other branches.</p>
<h2 id="a-new-drawing-board">A New Drawing Board</h2>
<p>So, again, I was stumped.  If you compare two <code>namedtuples</code> with one another, all the data has to match or they aren't considered equal.  Even if I could solve that problem, there was still the problem of the hash lookup in the dictionary.  If two <code>namedtuples</code> don't have the exact same data in them, their hashes won't match and thus looking it up in a dictionary will always fail.</p>
<p>Digging into Python's hash magic methods, I hit upon a simple idea.  Make all the hashes the same.  That way Python is <em>forced</em> to use the equality function on the <code>namedtuples</code> when it compares them against the dictionary keys.</p>
<h2 id="a-new-hope">A New Hope</h2>
<p>Thankfully everything in Python has public visibility.  The upshot of this is it means that I can create my own custom <code>namedtuple</code> that provides all the benefits of immutability as well as the readability of the fields, along with a custom equality function.</p>
<p>What this all boils down to is this bit of code for creating the Template for the dictionary.  These are meant to be filled with data and used as the keys in the lookup dictionary.  In addition, this <code>namedtuple</code> is used to fill out the data to be compared against the keys in the dictionary.</p>
<pre data-lang="python" class="language-python "><code class="language-python" data-lang="python"># Decision matrix used in determining which data process to kick off
Template = namedtuple(&quot;Template&quot;, [&#x27;pred1&#x27;, &#x27;pred2&#x27;, &#x27;pred3&#x27;, &#x27;pred4&#x27;, &#x27;pred5&#x27;, &#x27;pred6&#x27;, &#x27;pred7&#x27;])
# Default any non-filled out fields to None
Template.__new__.__defaults__ = (None,) * len(Template._fields)
# Disable the hash function
Template.__hash__ = lambda self: 1
# Set our custom equality function
Template.__eq__ = rd_eq
</code></pre>
<h2 id="custom-equality">Custom Equality</h2>
<p>&quot;Custom Equality&quot; is such a great term, and it really threw the more science-minded folks for a loop!</p>
<p>To ease their trepidation, I told them that I wasn't <em>really</em> setting up a custom equality, I was making sure that it works as a template rather than an exact match.  If data shows up in the template, it's important, if it doesn't, then it's not and can be anything.</p>
<p>Note that the bottom code is more complex than just a simple template.  If you notice in the original code, there's a lot of <code>if x in ['a', 'b', 'c', 'd']</code> thrown around along with at least one <code>if ['a', 'b'] == ['a', 'b', 'c']</code> style.  That makes comparing against a template messy.</p>
<pre data-lang="python" class="language-python "><code class="language-python" data-lang="python">def rd_eq(template, other):
    &quot;&quot;&quot;Compare fields in template to fields in other if template.field is not None
    template and other are expected to be namedtuples, tuples, or lists.
    Order of the elements in each *does* matter.
    If an element is a list, make sure that all the subelements of that list appear in the template.
    :param template: namedtuple, non-null values are used for comparison
    :param other: namedtuple, all&#x2F;some&#x2F;none values can be filled out and will be compared with non-null values from template
    :return: true if the non-null values in template &quot;match&quot; in other, false otherwise
    &quot;&quot;&quot;
    # compare template type to other type
    if template.__class__ != other.__class__ or len(template) != len(other):
        return False
    for template_val, other_val in zip(template, other):
        if template_val is not None:  # only &quot;filled out&quot; template values matter
            # compare element types
            if isinstance(template_val, list):
                if isinstance(other_val, list):
                    # if all the values in the &quot;template&quot; don&#x27;t exist in the &quot;other&quot;, return false
                    if len(set(template_val).intersection(set(other_val))) != len(set(template_val)):
                        return False
                else:
                    if other_val not in template_val:
                        return False
            elif template_val != other_val:
                return False
    return True
</code></pre>
<p>It's worth reading through a few times, but in a nutshell:</p>
<ul>
<li>If the value of a field in the template is filled in, try to compare it</li>
<li>If the value of the field is a list and the value being compared against isn't, make sure the value being compared against is in the list.</li>
<li>If the value of the field is a list and the value being compared against is also a list, make sure the values in the template exist in the value being compared against.</li>
</ul>
<h2 id="the-final-frontier">The Final Frontier</h2>
<p>The last step in the crazy mess is to get our custom dictionary up and running.</p>
<p>First, we set up the list of templates in order from most-restrictive to least.</p>
<pre data-lang="python" class="language-python "><code class="language-python" data-lang="python"># Just a coupling of data function and basic log message to send
FnRunner = namedtuple(&quot;FnData&quot;, [&#x27;fn&#x27;, &#x27;log_message&#x27;])

decisions = [
    (Template(pred2=[&#x27;val1&#x27;]),
     FnRunner(fn=self.process_data_2, log_message=&#x27;Running data process 2&#x27;)),
    (Template(pred1=&#x27;first&#x27;,
              pred3=[state_management_2.state1, state_management_2.state3, state_management_2.state4],
                    pred4=True),
     FnRunner(fn=self.process_data_1, log_message=&#x27;Running data process 1&#x27;))
# &lt;snip&gt;
]
</code></pre>
<p>Then we shove it in an ordered dictionary to preserve the restrictiveness (fun fact, ordered dictionaries are compared in-order)</p>
<pre data-lang="python" class="language-python "><code class="language-python" data-lang="python">self.decision_tree = OrderedDict(decisions)
</code></pre>
<p>From there, we get the data to compare against and shove it into a Template <code>namedtuple</code> and fire off the comparison:</p>
<pre data-lang="python" class="language-python "><code class="language-python" data-lang="python"># get the realtime data to compare against the templates
runner_data = Template(get_decision_data())

# create a noop function if we don&#x27;t find a lookup in self.decision_tree
runner_noop = FnRunner(fn=lambda *args, **kwargs: RunnerResults(),
                       log_message=&quot;Nothing to do, ignoring&quot;)

# lookup the correct data runner function to run
# this is where the equality is called and everything is bashed against one another
data_runner_fn = self.decision_tree.get(runner_data, runner_noop)

# finally, run the function we found
output_data, log_message = data_runner_fn()
</code></pre>
<h2 id="conclusion">Conclusion</h2>
<p>Once I was done with all of this crazyness and had a working prototype that passed at least some of the tests I bounced it off of the team.  Their reactions were a pretty mixed bag, everything from disbelief that I had actually refactored the if-statement-of-crazy to curiosity at <em>how</em> I had done it.</p>
<p>To be honest, I'm still not 100% satisfied with the result, but the feedback in the following weeks was nothing but positive.  This is telling because around the same time, the business logic now encoded in the dictionary changed drastically.  This change was estimated to take around 2-4 weeks in the old if statement.  In the new one, it was done in 2 days.</p>
<p>I think the increase in productivity speaks for itself.</p>

          </div>
        </article>
      </div>
      
    </div>
  </div>
</section>


  
  <section class="modal" id="search-modal">
    <div class="modal-background"></div>
    <div class="modal-card">
      <header class="modal-card-head">
        <p class="modal-card-title">Search</p>
      </header>
      <section class="modal-card-body">
        <div class="field mb-2">
          <div class="control">
            <input class="input" id="search" placeholder="Search this website." type="search" />
          </div>
        </div>
        <div class="search-results">
          <div class="search-results__items"></div>
        </div>
      </section>
    </div>
    <button aria-label="close" class="modal-close is-large"></button>
  </section>
  


  

<section class="section">
  <div class="container">
    <div class="columns is-centered">
      <div class="column is-8">
        <nav class="level">
          
          <div class="level-item has-text-centered">
            <a class="button is-black is-outlined" href="https:&#x2F;&#x2F;bryan-lott.github.io&#x2F;2017-recap&#x2F;">
              <span class="icon mr-2">
                <i class="fas fa-arrow-circle-left"></i>
              </span>
              2017 Recap
            </a>
          </div>
           
          <div class="level-item has-text-centered">
            <a class="button is-black is-outlined" href="https:&#x2F;&#x2F;bryan-lott.github.io&#x2F;doing-what-you-love&#x2F;">
              Doing what you Love<span class="icon ml-2">
                <i class="fas fa-arrow-circle-right"></i>
              </span>
            </a>
          </div>
            
        </nav>
      </div>
    </div>
  </div>
</section>



  



  <footer class="footer py-4">
    <div class="content has-text-centered">
      <p>
        Built with
        <span class="icon-text">
          <span class="icon">
            <i class="fas fa-code"></i>
          </span>
          <span>code</span>
        </span>
        and
        <span class="icon-text">
          <span class="icon">
            <i class="fas fa-heart"></i>
          </span>
          <span>love</span>
        </span>
      </p>
      <p>
        Powered by
        <span class="icon-text">
          <span class="icon">
            <i class="fas fa-power-off"></i>
          </span>
          <span>zola</span>
        </span>
      </p>
    </div>
  </footer>

  
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" integrity="sha384-vtXRMe3mGCbOeY7l30aIg8H9p3GdeSe4IFlP6G8JMa7o7lXvnz3GFKzPxzJdPfGK" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/galleria@1.6.1/dist/galleria.min.js" integrity="sha384-QSfwGT8/EU536DKdtyP2D6SLlh8zBaZ0cVkwfrwhqzIU9VCfJT00CLVP5t+HAiYg" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/galleria@1.6.1/dist/themes/folio/galleria.folio.min.js" integrity="sha384-DwpKI+deZB267+hPKwiOIc5Y2GKsVL0mR6hgz7GgIu7AgAMYqJwcJKY1YBNfhWcY" crossorigin="anonymous"></script>
  
  
  <script src="https://cdn.jsdelivr.net/npm/mermaid@8.13.5/dist/mermaid.min.js" integrity="sha384-0yWn54pSGtfKCU+skfA69l25VsCw+MZt4LQov3xNRoS7YkAMrFokGgSBnAWSK4pv" crossorigin="anonymous"></script>
  
  
  <script src="https://cdn.jsdelivr.net/npm/chart.xkcd@1.1.13/dist/chart.xkcd.min.js" integrity="sha384-xC3h1+IHXK8seA+8KfT79Z4e0GPsznjXBoMa5nd8ooWKplPyXx92NOmljWxLC/cs" crossorigin="anonymous"></script>
  
  
  <script src="https://bryan-lott.github.io/elasticlunr.min.js"></script>
  <script src="https://bryan-lott.github.io/search_index.en.js"></script><script src="https://bryan-lott.github.io/js/site.js"></script>

  





  
  
</body>

</html>
